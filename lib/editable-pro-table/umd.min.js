(function(e,t){"object"===typeof exports&&"object"===typeof module?module.exports=t(require("el-table-prepend")):"function"===typeof define&&define.amd?define(["el-table-prepend"],t):"object"===typeof exports?exports["index"]=t(require("el-table-prepend")):e["index"]=t(e["el-table-prepend"])})("undefined"!==typeof self?self:this,function(e){return function(){"use strict";var t={309:function(t){t.exports=e}},r={};function o(e){var n=r[e];if(void 0!==n)return n.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,o),i.exports}!function(){o.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return o.d(t,{a:t}),t}}(),function(){o.d=function(e,t){for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}}(),function(){o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){o.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){o.p=""}();var n={};if(o.r(n),o.d(n,{default:function(){return Q}}),"undefined"!==typeof window){var i=window.document.currentScript,a=i&&i.src.match(/(.+\/)[^/]+\.js(\?.*)?$/);a&&(o.p=a[1])}var s=function(){var e=this,t=e._self._c;return t(e.formRef?"fragment":"el-form",e._b({tag:"component"},"component",e.getDynamicProps,!1),[t("el-table-prepend",e._g(e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"editableProTableRef",staticClass:"editable-pro-table",class:e.className,attrs:{data:e.form[e.name]},scopedSlots:e._u(["top"!==e.initializedCreatorProps.position||e.exceedsMax?null:{key:"prepend",fn:function(){return[t("div",{staticClass:"btn-add-box"},[t("RecordCreator",{attrs:{recordCreatorProps:e.initializedCreatorProps,size:e.defaultSize},nativeOn:{click:function(t){return e.addEditRecord(null)}}})],1)]},proxy:!0}],null,!0)},"el-table-prepend",e.initializedTableProps,!1),e.tableEvents),e._l(e.initializedColumns,function(r,o){return t("el-table-column",e._b({key:r.prop||r.key,scopedSlots:e._u([r.renderCellHeader?{key:"header",fn:function(e){return[t("CustomRender",{attrs:{render:()=>r.renderCellHeader(e)}})]}}:null,r.valueType||r.renderField?{key:"default",fn:function(o){return["option"===r.valueType?[t("Editable",{attrs:{editable:e.initializedEditable,action:{cancelEditable:e.cancelEditable,startEditable:e.startEditable,addEditRecord:e.addEditRecord},validateRow:e.validateRow,recordKey:o.row[e.rowKey],scope:o,name:e.name,render:e=>r.renderCell(o,e),newLineRecordCache:e.newLineRecordCache,preEditRows:e.preEditRows,defaultSize:e.defaultSize},on:{delete:e.filterByRecordKey,cancel:e.deleteOrResetRow}})]:[t("RenderCell",{attrs:{editable:e.initializedEditable,column:r,name:e.name,recordKey:o.row[e.rowKey],scope:o,cachedOptions:e.cachedOptions,preEditRows:e.preEditRows},scopedSlots:e._u([{key:r.prop,fn:function(t){return[e._t(r.prop,null,null,t)]}}],null,!0)})]]}}:null],null,!0)},"el-table-column",e.getColumnProps(r,o),!1))}),1),"bottom"!==e.initializedCreatorProps.position||e.exceedsMax?e._e():t("RecordCreator",{attrs:{recordCreatorProps:e.initializedCreatorProps,size:e.defaultSize},nativeOn:{click:function(t){return e.addEditRecord(null)}}})],1)},l=[],d=o(309),c=o.n(d),p=function(){var e=this,t=e._self._c;return t("el-button",e._b({staticClass:"btn-add",style:e.recordCreatorProps.style,attrs:{icon:"el-icon-plus"}},"el-button",e.initializedButtonProps,!1),[e._v(" "+e._s(e.recordCreatorProps.creatorButtonText)+" ")])},u=[],f={name:"RecordCreator",props:{recordCreatorProps:{type:[Boolean,Object],required:!0},size:{type:String}},computed:{initializedButtonProps(){const{size:e,recordCreatorProps:{buttonProps:t={}}}=this;return{plain:!0,...t,size:e}}}},m=f;function h(e,t,r,o,n,i,a,s){var l,d="function"===typeof e?e.options:e;if(t&&(d.render=t,d.staticRenderFns=r,d._compiled=!0),o&&(d.functional=!0),i&&(d._scopeId="data-v-"+i),a?(l=function(e){e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,e||"undefined"===typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),n&&n.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(a)},d._ssrRegister=l):n&&(l=s?function(){n.call(this,(d.functional?this.parent:this).$root.$options.shadowRoot)}:n),l)if(d.functional){d._injectStyles=l;var c=d.render;d.render=function(e,t){return l.call(t),c(e,t)}}else{var p=d.beforeCreate;d.beforeCreate=p?[].concat(p,l):[l]}return{exports:e,options:d}}var y,b,g=h(m,p,u,!1,null,"162f12bc",null),v=g.exports,w={name:"CustomRender",props:{render:{type:Function,required:!0}},render:function(e){return e("Fragment",[this.render()])}},x=w,R=h(x,y,b,!1,null,"2ddfacb0",null),C=R.exports,E=function(){var e=this,t=e._self._c;return t("Fragment",[e.isEditable?t("FormItem",{attrs:{formItem:e.formItem,formItemProp:e.formItemProp,form:e.row,name:e.name,recordKey:e.recordKey,index:e.index},scopedSlots:e._u([{key:e.formItem.prop,fn:function(){return[e._t(e.formItem.prop,null,null,{form:e.row,formItem:e.formItem,recordKey:e.recordKey,index:e.index})]},proxy:!0}],null,!0)}):[t("el-form-item",{staticClass:"editable-form-item",attrs:{prop:e.formItemProp}},[e.column.renderCell?t("CustomRender",{attrs:{render:()=>e.column.renderCell(e.scope)}}):t("span",{class:{"text-ellipsis":e.column["show-overflow-tooltip"]}},[e._v(e._s(e.value??"-"))])],1)]],2)},_=[],S=function(){var e=this,t=e._self._c;return t("el-form-item",e._b({staticClass:"editable-form-item",attrs:{prop:e.formItemProp,label:""}},"el-form-item",e.normalizedFormItem,!1),[e.formItem.renderField?t("CustomRender",{attrs:{render:()=>e.formItem.renderField({form:e.form,formItem:e.formItem,recordKey:e.recordKey,index:e.index})}}):"slot"===e.formItem.valueType?e._t(e.formItem.prop):t(`el-${e.formItem.valueType}`,e._g(e._b({tag:"component",model:{value:e.form[e.formItem.prop],callback:function(t){e.$set(e.form,e.formItem.prop,t)},expression:"form[formItem.prop]"}},"component",e.formItem.fieldProps,!1),e.normalizedFieldEvents),["select"===e.formItem.valueType?[e.formItem.options?.[0]?.options?e._l(e.formItem.options,function(r){return t("el-option-group",e._b({key:r.label},"el-option-group",r,!1),e._l(r.options,function(r){return t("el-option",e._b({key:r.value},"el-option",r,!1))}),1)}):e._l(e.formItem.options,function(r){return t("el-option",e._b({key:r.value},"el-option",r,!1))})]:e.groups.includes(e.formItem.valueType)?e._l(e.formItem.options,function(r){return t(e.selection[e.formItem.valueType],{key:r.value,tag:"component",attrs:{label:r.value}},[e._v(" "+e._s(r.label)+" ")])}):e._e()],2)],2)},I=[],P={name:"FormItem",components:{CustomRender:C},props:{formItem:{type:Object,required:!0},form:{type:Object,required:!0},name:{type:String},recordKey:{type:[Number,String]},index:{type:Number},formItemProp:{type:String}},computed:{normalizedFormItem(){const{valueType:e,renderField:t,fieldProps:r,fieldEvents:o,options:n,valueEnum:i,optionLoader:a,initialValue:s,colProps:l,...d}=this.formItem;return d},normalizedFieldEvents(){const{formItem:{fieldEvents:e}}=this;if(!e)return;const t={},{recordKey:r,form:o,index:n}=this;for(const i in e){const a=(...t)=>e[i]?.(...t,{recordKey:r,row:o,index:n});t[i]=a}return t}},data(){return{groups:["radio-group","checkbox-group"],selection:{"radio-group":"el-radio","checkbox-group":"el-checkbox"}}}},K=P,O=h(K,S,I,!1,null,"1ac7c73e",null),z=O.exports;function T(e){switch(e){case"input":case"input-number":return"请输入";case"select":case"time-picker":case"date-picker":case"cascader":return"请选择";default:return""}}function L(e,t){e.placeholder=e.placeholder??T(t)}function k(e,t){const{valueType:r,prop:o,options:n,valueEnum:i,optionLoader:a}=e;"select"===r&&(n?.length>0||(i?i instanceof Map?e.options=Array.from(i,([e,t])=>({label:t,value:e})):e.options=Object.entries(i).map(([e,t])=>({label:t,value:e})):e.options=a&&t[o]?t[o]:[]))}function F(e,t,r){const{valueType:o,prop:n,optionLoader:i}=t;"cascader"===o&&(e.options?.length>0||i&&r[n]&&(e.options=r[n]))}var j,$,N={name:"RenderCell",components:{FormItem:z,CustomRender:C},props:{editable:{type:Object,required:!0},column:{type:Object,required:!0},scope:{type:Object},name:{type:String,required:!0},recordKey:{type:[String,Number]},cachedOptions:{type:Object},preEditRows:{type:Map}},computed:{formItem(){const{column:e,column:{prop:t,formItemProps:r={},valueType:o,renderField:n,fieldProps:i={},fieldEvents:a}}=this;return L(i,o),k(e,this.cachedOptions),F(i,e,this.cachedOptions),{...r,prop:t,valueType:o,renderField:n,fieldProps:i,fieldEvents:a,options:e.options}},row(){return this.scope.row},index(){return this.scope.$index},formItemProp(){const{formItem:{prop:e},name:t,index:r}=this;return`${t}.${r}.${e}`},isEditable(){const{editable:{editableKeys:e},recordKey:t,formItem:{prop:r},column:{readonly:o,editable:n}}=this,i=this.preEditRows.get(this.recordKey)?.[r];return e?.some(e=>t===e)&&!0!==o&&(!n||n?.(i,this.row,this.index))},value(){const{column:{formatter:e},formItem:t,scope:r,row:o,index:n}=this,{prop:i,valueType:a,options:s,valueEnum:l}=t,d=o[i];if(e)return e(o,r.column,d,n);if("select"===a){if(l)return l instanceof Map?l.get(d):l[d];{const e=(s||[]).reduce((e,t)=>({...e,[t.value]:t.label}),{});return e[d]}}return d}}},M=N,q=h(M,E,_,!1,null,"5943cebf",null),B=q.exports,A={name:"Editable",props:{editable:{type:Object,required:!0},action:{type:Object,required:!0},validateRow:{type:Function},recordKey:{type:[String,Number]},render:{type:Function,required:!0},scope:{type:Object},newLineRecordCache:{type:Object},name:{type:String},preEditRows:{type:Map},defaultSize:{type:String}},computed:{isEditable(){const{editable:{editableKeys:e},recordKey:t}=this;return e?.some(e=>t===e)},isNewLineRecordCache(){return this.newLineRecordCache?.options.recordKey===this.recordKey}},data(){return{saveLoading:!1,visible:!1,deleteLoading:!1}},methods:{async save(){const{validateRow:e,scope:{row:t,$index:r},recordKey:o}=this,n=await e(r);if(n)try{this.saveLoading=!0;const e=await(this.editable.onSave?.(o,t,this.preEditRows.get(o)));if(this.saveLoading=!1,!1===e)return;this.action.cancelEditable(o,t)}catch(i){this.saveLoading=!1,console.error("err",i)}},async delete(){try{this.deleteLoading=!0;const{scope:{row:e},recordKey:t}=this,r=await(this.editable.onDelete?.(t,e));if(this.deleteLoading=!1,!1===r)return;this.visible=!1,await this.action.cancelEditable(t,e),this.$emit("delete",t)}catch(e){this.deleteLoading=!1,console.error("err",e)}},async cancel(){try{const{recordKey:e,scope:{row:t,$index:r}}=this;await this.action.cancelEditable(e,t),this.$emit("cancel",e,r)}catch(e){console.error("err",e)}}},render:function(e){const{saveText:t,deleteText:r,cancelText:o,deletePopconfirmMessage:n}=this.editable,{defaultSize:i}=this,a={save:e("el-button",{class:"btn-save",attrs:{type:"text",size:i,loading:this.saveLoading},on:{click:this.save}},[t]),delete:e("el-popover",{attrs:{placement:"top","popper-class":"delete-popover-message",trigger:"click",value:this.visible},on:{input:e=>this.visible=e}},[e("p",[e("i",{class:"el-icon-warning",style:"color: #ffad00; margin-right: 8px"}),e("span",[n])]),e("div",{style:"text-align: right; margin-left: 22px"},[e("el-button",{attrs:{size:"mini",type:"text"},on:{click:()=>{this.visible=!1}}},["取消"]),e("el-button",{attrs:{type:"primary",size:"mini"},on:{click:this.delete}},["确定"])]),e("el-button",{slot:"reference",attrs:{type:"text",size:i,loading:this.deleteLoading}},[r])]),cancel:e("el-button",{class:"btn-cancel",attrs:{type:"text",size:i},on:{click:this.cancel}},[o])},{editable:{editableKeys:s,onChange:l,onSave:d,onDelete:c,onCancel:p,actionRender:u},scope:{row:f},isNewLineRecordCache:m}=this,{recordKey:h,scope:{$index:y},action:{cancelEditable:b,addEditRecord:g},name:v,newLineRecordCache:w}=this,x={editableKeys:s,setEditableRowKeys:e=>l?.(e),recordKey:h,preEditRow:this.preEditRows.get(h),index:y,onSave:d,onDelete:c,onCancel:p,cancelEditable:b,newLineConfig:w,saveText:t,deleteText:r,cancelText:o,deletePopconfirmMessage:n,addEditRecord:g,tableName:v},R=[a.save,!m&&a.delete,a.cancel].filter(Boolean),C="function"===typeof u?u(f,x,a):R;return e("Fragment",[this.isEditable?C:this.render(this.action)])}},D=A,V=h(D,j,$,!1,null,"39818f6b",null),J=V.exports,H={name:"EditableProTable",components:{ElTablePrepend:c(),RecordCreator:v,CustomRender:C,RenderCell:B,Editable:J},inject:{formRef:{from:"elForm",default:null}},props:{dataSource:{type:Array,required:!0,default:()=>[]},recordCreatorProps:{type:[Boolean,Object],default:!0},maxLength:{type:Number},editable:{type:Object},rowKey:{type:String},name:{type:String,default:"dataSource"},className:{type:String},loading:{type:Boolean},tableProps:{type:Object},tableEvents:{type:Object},columns:{type:Array,required:!0,default:()=>[]},defaultSize:{type:String,validator:function(e){return["medium","small","mini"].includes(e)}},sticky:{type:Boolean,default:!0}},computed:{getDynamicProps(){const{formRef:e,form:t,defaultSize:r}=this;if(!e)return{ref:"formRef",model:t,size:r}},initializedCreatorProps(){const{recordCreatorProps:e}=this;if(e){const t={position:"bottom",newRecordType:"cache",creatorButtonText:"添加一行数据",onlyAddOneLineAlertMessage:"只能新增一行"};return"object"===typeof e?{...t,...e}:t}return!1},exceedsMax(){const{maxLength:e}=this;return"number"===typeof e&&this.form[this.name].length>=e},initializedEditable(){const e={type:"single",saveText:"保存",deleteText:"删除",cancelText:"取消",deletePopconfirmMessage:"删除此项？",onlyOneLineEditorAlertMessage:"只能同时编辑一行"};return{...e,...this.editable}},initializedTableProps(){const{rowKey:e,tableProps:t={},defaultSize:r}=this;return{...t,rowKey:e,size:r,"cell-style":e=>this.getCellStyle(e,t["cell-style"]),"header-cell-style":e=>this.getCellStyle(e,t["header-cell-style"])}},initializedColumns(){return this.columns.filter(e=>!e.hideInTable)},calculateOffset(){const e={},{initializedColumns:t,sticky:r}=this;let o=0,n=-1;for(let s=0;s<t.length;s++){const i=t[s],a=!1!==r&&"left"===i.fixed;a&&(n=s,e[s]=o,o+=i.width||i.minWidth)}let i=0,a=-1;for(let s=t.length-1;s>=0;s--){const o=t[s],n=!1!==r&&"right"===o.fixed;n&&(a=s,e[s]=i,i+=o.width||o.minWidth)}return{offset:e,leftIndex:n,rightIndex:a}}},data(){return{cachedOptions:{},form:{[this.name]:this.dataSource},newLineRecordCache:void 0,preEditRows:new Map}},created(){this.getOptions()},watch:{dataSource(e){this.form[this.name]=e}},methods:{getOptions(){for(const e of this.columns){const{prop:t,optionLoader:r}=e;"function"===typeof r&&r().then(e=>{this.cachedOptions={...this.cachedOptions,[t]:e}})}},addEditRecord(e,t){const{initializedCreatorProps:{onlyAddOneLineAlertMessage:r}}=this;if(this.newLineRecordCache)return void this.$message.warning(r);if(!this.validateCanStartEdit())return;const{form:o,name:n,rowKey:i}=this,{initializedCreatorProps:{position:a,newRecordType:s,record:l}}=this,d=o[n],c={position:a,newRecordType:s,...t||{}},p="top"===c.position?d.length:0;e=e??l;const u="function"===typeof e?e(p,d):e;if(!u[i])return void console.error("Error: 请设置 recordCreatorProps.record 并返回一个唯一的key");"dataSource"!==c.newRecordType?this.newLineRecordCache={defaultValue:JSON.parse(JSON.stringify(u)),options:{...c,recordKey:u[i]}}:this.newLineRecordCache=void 0,"top"===c.position?d.unshift(u):d.push(u);const{initializedEditable:{editableKeys:f,onChange:m}}=this,h=[...f,u[i]],y=d.filter(e=>f.includes(e[i]));m?.(h,y)},getColumnProps(e,t){const{formItemProps:r,renderLabel:o,valueType:n,renderField:i,fieldProps:a,fieldEvents:s,options:l,valueEnum:d,optionLoader:c,renderCellHeader:p,renderCell:u,editable:f,readonly:m,key:h,...y}=e,{sticky:b}=this,g=(e,t)=>t?"left"===e?"editable-pro-table__fixed-left":"right"===e?"editable-pro-table__fixed-right":"":"";let v=e["class-name"]||"";return e.fixed&&b&&(v+=" "+g(e.fixed,b)),this.calculateOffset.leftIndex===t?v+=" editable-pro-table__fixed-start-shadow":this.calculateOffset.rightIndex===t&&(v+=" editable-pro-table__fixed-end-shadow"),{...y,fixed:e.fixed&&b?void 0:e.fixed,"class-name":v}},getValidateFields(e){return this.columns.filter(e=>e.valueType&&"option"!==e.valueType||e.renderField).map(t=>`${this.name}.${e}.${t.prop}`)},validateRow(e){return new Promise(async t=>{const r=this.getValidateFields(e),o=r.map(e=>new Promise(t=>{this.getFormRef()?.validateField(e,e=>{t(!e)})})),n=await Promise.all(o);t(!n.some(e=>!e))})},validateCanStartEdit(){const{initializedEditable:{type:e,editableKeys:t,onlyOneLineEditorAlertMessage:r}}=this;return!t.length||"single"!==e||(this.$message.warning(r),!1)},clearEditableState(e){const{initializedEditable:{editableKeys:t,onChange:r}}=this;if(!t.includes(e))return!0;const o=t.filter(t=>t!==e);r?.(o)},clearNewLineCache(e){this.newLineRecordCache?.options.recordKey===e&&(this.newLineRecordCache=null)},async cancelEditable(e,t){try{const r=this.preEditRows.get(e);await(this.editable.onCancel?.(e,t,r)),this.clearEditableState(e),this.clearNewLineCache(e)}catch(r){console.error("err",r)}return!0},findRecordByKey(e){const t=this.form[this.name],r=t.find(t=>t[this.rowKey]===e);return JSON.parse(JSON.stringify(r))},startEditable(e){if(!this.validateCanStartEdit())return!1;const{initializedEditable:{editableKeys:t,onChange:r}}=this,o=t?.some(t=>t===e);return o||(r?.([...t,e]),this.preEditRows.set(e,this.findRecordByKey(e))),!0},filterByRecordKey(e){const{form:t,name:r,rowKey:o}=this,n=t[r],i=n.findIndex(t=>t[o]===e);-1!==i&&n.splice(i,1)},deleteOrResetRow(e,t){const{initializedCreatorProps:{newRecordType:r}}=this,o=this.preEditRows.get(e);if(o){const{form:t,name:r,rowKey:n}=this,i=t[r],a=i.findIndex(t=>t[n]===e);-1!==a&&i.splice(a,1,o)}else if("dataSource"!==r)this.filterByRecordKey(e);else{const{initializedCreatorProps:{record:e},form:r,name:o,rowKey:n}=this,i=r[o],a="function"===typeof e?e(t,i):e;delete a[n],this.setRowData(t,a)}},getFormRef(){return this.formRef||this.$refs.formRef},validate(){return this.getFormRef()?.validate},reset(){return this.getFormRef()?.resetFields},getTableRef(){return this.$refs.editableProTableRef},getRowData(e){const t=this.form[this.name];return"number"===typeof e&&e<t.length?t[e]:t.find(t=>t[this.rowKey]===e)},getRowsData(){return this.form[this.name]},setRowData(e,t){const r=this.form[this.name];if("number"===typeof e&&e<r.length)console.log({...r[e],...t}),r.splice(e,1,{...r[e],...t});else{const o=r.findIndex(t=>t[this.rowKey]===e);-1!==o&&r.splice(o,1,{...r[o],...t})}},getCellStyle({row:e,column:t,rowIndex:r,columnIndex:o},n){const i=n?.({row:e,column:t,rowIndex:r,columnIndex:o}),a=this.getStickyStyle(o,this.initializedColumns[o].fixed);if("string"===typeof i){let e="";if(e+=i+";",a){const t=Object.entries(a).map(([e,t])=>`${e}: ${t};`);e+=t}return e}return i instanceof Object?{...i,...a||{}}:a},getStickyStyle(e,t){const r=this.calculateOffset.offset[e];if(void 0!==r)return{[t]:`${r}px`}}}},U=H,W=h(U,s,l,!1,null,"b718f0f2",null),X=W.exports;X.install=function(e){e.component(X.name,X)};var G=X,Q=G;return n}()});
//# sourceMappingURL=index.umd.min.js.map